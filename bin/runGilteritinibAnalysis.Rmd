---
title: "Gilteritinib Differntial Protein Analysis"
author: "Sara Gosline"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(amlresistancenetworks)
require(dplyr)
```

## Get Data

This package has formatted the Gilteritnib-treated AML cells into a tidied data frame so they can be easily processed. Here is a summary of the samples collected so that we can better analyze them.

Conditions:
```{r Load Data}
gilt.data<-readRDS(system.file('gilteritinibData.Rds',package='amlresistancenetworks'))

#view as table
samps<-gilt.data%>%
  dplyr::select(c(Sample,ligand,CellLine,treatment))%>%distinct()

DT::datatable(samps)
```

## Compute fold changes for conditions of interest


Here is the meat of the challenge - compute significant LFCs for each condition.

```{r LFC heatmap, echo=FALSE, include=FALSE, warning=FALSE}

library(pheatmap)

#get data in matrix form
full.mat<-gilt.data%>%
    subset(!is.na(value))%>%
    subset(!is.na(Gene))%>%
    select(value,`Sample ID`,Gene)%>%
    tidyr::pivot_wider(names_from='Sample ID',values_from='value',values_fn=list(value=mean))%>%
    tibble::column_to_rownames("Gene")%>%
    as.matrix()

nas<-which(apply(full.mat,1,function(x) any(is.na(x))))
if(length(nas)>0)
  full.mat<-full.mat[-nas,]

vars=apply(full.mat,1,var,na.rm=T)
most.var=names(sort(vars,decreasing=T)[1:50])

full.samps=gilt.data%>%
    select(c(`Sample ID`,CellLine,ligand,treatment))%>%
    distinct()%>%tibble::column_to_rownames("Sample ID")

pheatmap(full.mat[most.var,],cellwidth=10,cellheight=10,annotation_col = full.samps, clustering_method = 'ward.D2',file='mostVarProts.png')


```
While there are general patterns between treatment effects and ligands, there are still spurious clusterings brought about by noise making it difficult to draw strong conclustions from the proteins driving these changes.

## Compute differences between ligand treatments

Now we can compute the means of the values so that we can see the driving effects. 
```{r mean value heatmap,cho=FALSE, include=FALSE, warning=FALSE}

mean.vals<-gilt.data%>%
  dplyr::select(CellLine,Gene,treatment,ligand,value)%>%
  group_by(CellLine,Gene,treatment,ligand)%>%
  subset(!is.na(value))%>%
  subset(!is.na(Gene))%>%
  summarize(meanVal=mean(value,na.rm=TRUE))%>%
  rowwise()%>%mutate(condition=paste(c(CellLine,treatment,ligand),collapse='_'))

samps=mean.vals%>%
  select(condition,CellLine,treatment,ligand)%>%
  distinct()%>%
  tibble::column_to_rownames('condition')

mat<-mean.vals%>%select(condition,Gene,meanVal)%>%
  tidyr::pivot_wider(names_from=condition,values_from=meanVal,values_fn=list(meanVal=mean))%>%
  tibble::column_to_rownames('Gene')%>%
  as.matrix()

vars=apply(mat,1,var,na.rm=T)
most.var=names(sort(vars,decreasing=T)[1:50])

pheatmap(mat[most.var,],cellwidth=10,cellheight=10,annotation_col = samps, clustering_method = 'ward.D2',file='mostVarProtMeans.png')

```

For the purposes of this study, we are interested in determining _which_ proteins are driving changes in drug response, not necessarily how similar/different they are. For this we compute the mean differences between protein activity for specific conditions of interest.


```{r raw differences,echo=FALSE, include=FALSE, warning=FALSE}

#reduce data
mean.diffs<-computeFoldChangePvals(gilt.data)

```

Now that we've collected the various gene lists we can select those and do enrichment in the ones of interest. 
```{r topgenes,warning=FALSE,echo=FALSE,results='hide'}
fl.counts=mean.diffs%>%
    subset(FL_adj<0.05)%>%
    group_by(CellLine)%>%
    summarize(`FL proteinsDiffEx`=n())

fgf.counts=mean.diffs%>%
    subset(FGF2_adj<0.05)%>%
    group_by(CellLine)%>%
    summarize(`FGF2 proteinsDiffEx`=n())

tot.counts<-fgf.counts%>%left_join(fl.counts,by='CellLine')
DT::datatable(tot.counts)

prots.fl=mean.diffs%>%
    subset(FL_adj<0.05)%>%ungroup()%>%
  select(Gene)

prots.fgf=mean.diffs%>%
    subset(FGF2_adj<0.05)%>%ungroup()%>%
  select(Gene)


pheatmap(full.mat[union(prots.fl$Gene,prots.fgf$Gene),],cellwidth=10,cellheight=10,annotation_col = full.samps, clustering_method = 'ward.D2',file='diffExProts.png')

```

### FGF2 and FLT3 Ligand in MV411

In the MV411 cell lines we evaluate the GO term enrichment using the `clusterProfiler` package along side the `MSigDB` `C2` gene lists. We use an FDR p-value correction and limit the genes searched to those in the protein universe - i.e. those that were measured in the initial dataset.


```{r mv411,echo=FALSE,warning=FALSE,results='hide'}

mv411<-subset(mean.diffs,CellLine=='MV411')
prot.univ<-unique(gilt.data$Gene)

```

#### FGF2 treated MV411

```{r,echo=FALSE, warning=FALSE,results='hide'}
genes.with.values=mv411%>%ungroup()%>%dplyr::select(Gene,value=FGF2_to_parent)

mv411.fgf2=computeGSEA(genes.with.values,prot.univ)

clusterProfiler::barplot(mv411.fgf2,showCategory=20)+ggplot2::ggtitle("GO Terms for MV411 FGF2")
genes.with.values = mv411%>%ungroup()%>%dplyr::select(Gene,value=FL_to_parent)
```

#### FL treated MV411

```{r,echo=FALSE, warning=FALSE,results='hide'}
mv411.fl=computeGSEA(genes.with.values,prot.univ)

if(nrow(as.data.frame(mv411.fl))>0){
  clusterProfiler::barplot(mv411.fl,showCategory=20)+ggplot2::ggtitle("GO Terms for MV411 FLT3 Ligand")
  ggplot2::ggsave('MV411_FL_GO.png')
}

```

The results show distinct pathways enriched in the FLT3 ligand and FGF2 treated cells.


#### FGF2 vs FL treatment
Here we look at FGF2 vs FL3 ligand.
 
```{r mv411 diff, echo=FALSE,warning=FALSE,results='hide'}
genes.with.values=mv411%>%mutate(FGF2_vs_FLT=FGF2_to_parent-FL_to_parent)%>%
  ungroup()%>%dplyr::select(Gene,value=FGF2_vs_FLT)
mv411.diff=computeGSEA(genes.with.values,prot.univ)

if(nrow(as.data.frame(mv411.diff))>0){
clusterProfiler::barplot(mv411.diff,showCategory=20)+ggplot2::ggtitle("GO Terms for MV411 FGF2 vs FLT3 Ligase")
    ggplot2::ggsave('MV411_FL_vs_FGF2_GO.png')

}


```

### FGF2 and FLT3 Ligand in MOLM14 

How do these plots compare to the MV411 cell lines? One would hope they'd be the same.

```{r molm14, echo=T,warning=FALSE,results='hide'}

molm14<-subset(mean.diffs,CellLine=='MOLM14')
prot.univ<-unique(gilt.data$Gene)
```

#### FGF2 treated MOLM14
The plot below shows the GO terms enriched between FGF2-treated cells and parental MOLM14 cells.

```{r, echo=T,warning=FALSE,results='hide'}
genes.with.values=molm14%>%ungroup()%>%dplyr::select(Gene,value=FGF2_to_parent)
molm14.fgf2=computeGSEA(genes.with.values,prot.univ)

if(nrow(as.data.frame(molm14.fgf2))>0){
clusterProfiler::barplot(molm14.fgf2,showCategory=20)+ggplot2::ggtitle("GO Terms for molm14 FGF2")
    ggplot2::ggsave('MOLM14_FGF2_GO.png')

}
```

#### FL treated MOLM14

The plot below shows the GO terms enriched between FLT3 Ligand-treated cells and parental MOLM14 cells.

```{r,echo=FALSE,warning=FALSE,results='hide'}

molm14.fl=computeGSEA(molm14%>%ungroup()%>%dplyr::select(Gene,value=FL_to_parent),prot.univ)

if(nrow(as.data.frame(molm14.fl))>0){
  clusterProfiler::barplot(molm14.fl,showCategory=20)+ggplot2::ggtitle("GO Terms for molm14 FLT3 Ligand")
    ggplot2::ggsave('MOLM14_FL_GO.png')

}
```

#### FGF2 vs FL treatment

Here we look at the difference between FGF2 and FL ligand in both cell lines.
```{r molm14 diff,echo=FALSE,warning=FALSE,results='hide'}
genes.with.values=molm14%>%mutate(FGF2_vs_FLT=FGF2_to_parent-FL_to_parent)%>%
  ungroup()%>%dplyr::select(Gene,value=FGF2_vs_FLT)
molm14.diff=computeGSEA(genes.with.values,prot.univ)
if(nrow(as.data.frame(molm14.diff))>0){
clusterProfiler::barplot(mv411.diff,showCategory=20)+ggplot2::ggtitle("GO Terms for MOLM14 FGF2 vs FLT3 Ligase")
    ggplot2::ggsave('MOLM14_FL_vs_FGF2_GO.png')

}

```


